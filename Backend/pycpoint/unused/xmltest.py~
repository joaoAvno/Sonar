import brisa

from xml.etree.ElementTree import _ElementInterface, iterparse
from xml.etree import cElementTree as ElementTree

from brisa.core import log
from brisa.core.network import parse_xml

from brisa.upnp.didl import dlna
from brisa.upnp.didl.didl_lite import Container, Element, SonosMusicTrack

from xml.dom import minidom
from xml.dom.minidom import parseString

ns = {'didl': 'urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/',
      'dc': 'http://purl.org/dc/elements/1.1/',
      'upnp': 'urn:schemas-upnp-org:metadata-1-0/upnp/',
      'dlna': 'urn:schemas-dlna-org:metadata-1-0',
      'r' : 'urn:schemas-rinconnetworks-com:metadata-1-0/'}


#def find(elt, namespace, key):
#    f = elt.find('{%s}%s' % (ns[namespace], key))
#    if f is None:
#        return ()
#    return f

def find(elt, namespace, key):
    for node in elt.getchildren():
        print "find node: " + str(node)
        f = node.find('.//{%s}%s' % (ns[namespace], key))
        if f is None:
            return ()
        return f

def test():
    upnp_class_name = 'object.item.audioItem.musicTrack.sonosMusicTrack'
    print "upnp: " + upnp_class_name
    names = upnp_class_name.split('.')
    print names
    return
    while names:
        class_name = names[-1]
        print "cn: " + class_name
        class_name = "%s%s" % (class_name[0].upper(), class_name[1:])
        print "new cn: " + class_name
        try:
            print "eval....."
            upnp_class = eval(class_name)
#            new_node = upnp_class()
#            new_node.from_element(node)
#            add_item(new_node)
            break
        except Exception, e:
            names = names[:-1]
            log.debug('element from string critical bug: %s' % str(e))
            continue
    print "end of test()"

def process_event_tags_avt(val):
    print val

    print "ELEMENT ELEMENT ELEMENT ELEMENT ELEMENT ELEMENT 1111"
    elem = ElementItem.from_string(val)
    print elem
    print "ELEMENT ELEMENT ELEMENT ELEMENT ELEMENT ELEMENT 2222"
    '''
    print "----> elem.get_items()"
    print elem.get_items()
    print "----> elem.get_items()[0]"
    print elem.get_items()[0]
    print "ELEMENT ELEMENT ELEMENT ELEMENT ELEMENT ELEMENT 3333"
    print "----> elem.get_items()[0].to_string()"
    print elem.get_items()[0].to_string()
    print "ELEMENT ELEMENT ELEMENT ELEMENT ELEMENT ELEMENT 4444"
    attrib = elem.items()
    print "ATTRIB ATTRIB ATTRIB ATTRIB ATTRIB ATTRIB ATTRIB 1"
    print "----> attrib"
    print attrib
    print "ATTRIB ATTRIB ATTRIB ATTRIB ATTRIB ATTRIB ATTRIB 2"
    print "ITEM ITEM ITEM ITEM ITEM ITEM ITEM ITEM ITEM ITEM 1"

    it = elem.find('{%s}%s' % (ns['didl'], 'item'))
    print "----> it"
    print it

    for node in elem.getchildren():
        print "----> node"
        print node
        


    item = elem.getchildren()[0]
    for k,v in attrib:
        item.set(k,v)
    print "----> item"
    print item
    print "----> item.tostring()"
    print minidom.parseString(ElementTree.tostring(item)).toprettyxml()
    '''    
    '''        
register_namespace
ET.register_namespace(prefix, uri)
- does the prefix contain xmlns?
ET.register_namespace('xmlns', 'urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/')
ET.register_namespace('xmlns:dc', 'http://purl.org/dc/elements/1.1/')
ET.register_namespace('xmlns:upnp', 'urn:schemas-upnp-org:metadata-1-0/upnp/')
ET.register_namespace('xmlns:dlna', 'urn:schemas-dlna-org:metadata-1-0')
ET.register_namespace('xmlns:r', 'urn:schemas-rinconnetworks-com:metadata-1-0/')
    '''    

    
    print "ITEM ITEM ITEM ITEM ITEM ITEM ITEM ITEM ITEM ITEM 2"
    
#    ns = "{ns0}"
#    remove_namespace(item, ns)
    
#REMOVE NAMESPACE DOES NOT WORK HERE    
    
#    print "----> item removed ns"
#    print minidom.parseString(ElementTree.tostring(item)).toprettyxml()

    print "SMT SMT SMT SMT SMT SMT SMT SMT SMT SMT 1"

    elt = SonosMusicTrack()
#    elt.from_element(item)
    elt.from_element(elem)



def remove_namespace(doc, ns):
    """Remove namespace in the passed document in place."""
    nsl = len(ns)
    for elem in doc.getiterator():
        if elem.tag.startswith(ns):
            elem.tag = elem.tag[nsl:]
        
def ip(fname):
    print "file: " + fname
    events = ("end", "start-ns", "end-ns")
    for event, elem in iterparse('didl.xml', events=events):
        if event == "start-ns":
            print "start ns: " + str(elem)
        elif event == "end-ns":
            print "end ns: " + str(elem)
        else:
            print "end: " + str(elem)
    
def main():

#    i = '<DIDL-Lite xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:upnp="urn:schemas-upnp-org:metadata-1-0/upnp/" xmlns:r="urn:schemas-rinconnetworks-com:metadata-1-0/" xmlns="urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/"><item id="-1" parentID="-1" restricted="true"><res protocolInfo="x-file-cifs:*:audio/flac:*" duration="0:04:06">x-file-cifs://NAS/Music/All%20Angels/Into%20Paradise/06%20Sound%20Of%20Silence.flac</res><r:streamContent></r:streamContent><r:radioShowMd></r:radioShowMd><dc:title>Sound Of Silence</dc:title><upnp:class>object.item.audioItem.musicTrack.sonosMusicTrack</upnp:class><dc:creator>All Angels</dc:creator><upnp:album>Into Paradise</upnp:album><upnp:originalTrackNumber>6</upnp:originalTrackNumber><r:albumArtist>All Angels</r:albumArtist></item></DIDL-Lite>'
#    i = '<item id="-1" parentID="-1" restricted="true" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:upnp="urn:schemas-upnp-org:metadata-1-0/upnp/" xmlns:r="urn:schemas-rinconnetworks-com:metadata-1-0/" xmlns="urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/"><res protocolInfo="x-file-cifs:*:audio/flac:*" duration="0:04:06">x-file-cifs://NAS/Music/All%20Angels/Into%20Paradise/06%20Sound%20Of%20Silence.flac</res><r:streamContent></r:streamContent><r:radioShowMd></r:radioShowMd><dc:title>Sound Of Silence</dc:title><upnp:class>object.item.audioItem.musicTrack.sonosMusicTrack</upnp:class><dc:creator>All Angels</dc:creator><upnp:album>Into Paradise</upnp:album><upnp:originalTrackNumber>6</upnp:originalTrackNumber><r:albumArtist>All Angels</r:albumArtist></item>'
    '''
    i1 = '<DIDL-Lite xmlns="urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/">'
    i2 = '<item id="-1" parentID="-1" restricted="true">'
    i3 = '<res protocolInfo="x-file-cifs:*:audio/flac:*" duration="0:04:06">x-file-cifs://NAS/Music/All%20Angels/Into%20Paradise/06%20Sound%20Of%20Silence.flac</res>'
    i4 = '<{urn:schemas-rinconnetworks-com:metadata-1-0/}streamContent></{urn:schemas-rinconnetworks-com:metadata-1-0/}streamContent>'
    i5 = '<{urn:schemas-rinconnetworks-com:metadata-1-0/}radioShowMd></{urn:schemas-rinconnetworks-com:metadata-1-0/}radioShowMd>'
    i6 = '<{http://purl.org/dc/elements/1.1/}title>Sound Of Silence</{http://purl.org/dc/elements/1.1/}title>'
    i7 = '<{urn:schemas-upnp-org:metadata-1-0/upnp/}class>object.item.audioItem.musicTrack.sonosMusicTrack</{urn:schemas-upnp-org:metadata-1-0/upnp/}class>'
    i8 = '<{http://purl.org/dc/elements/1.1/}creator>All Angels</{http://purl.org/dc/elements/1.1/}creator>'
    i9 = '<{urn:schemas-upnp-org:metadata-1-0/upnp/}album>Into Paradise</{urn:schemas-upnp-org:metadata-1-0/upnp/}album>'
    i10 = '<{urn:schemas-upnp-org:metadata-1-0/upnp/}originalTrackNumber>6</{urn:schemas-upnp-org:metadata-1-0/upnp/}originalTrackNumber>'
    i11 = '<{urn:schemas-rinconnetworks-com:metadata-1-0/}albumArtist>All Angels</{urn:schemas-rinconnetworks-com:metadata-1-0/}albumArtist>'
    i12 = '</item></DIDL-Lite>'
    i = i1+i2+i3+i4+i5+i6+i7+i8+i9+i10+i11+i12
    '''
    '''
    i1 = '<DIDL-Lite xmlns="urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/">'
    i2 = '<item id="-1" parentID="-1" restricted="true">'
    i3 = '<res protocolInfo="x-file-cifs:*:audio/flac:*" duration="0:04:06">x-file-cifs://NAS/Music/All%20Angels/Into%20Paradise/06%20Sound%20Of%20Silence.flac</res>'
    i4 = '<urn:schemas-rinconnetworks-com:metadata-1-0/:streamContent></urn:schemas-rinconnetworks-com:metadata-1-0/:streamContent>'
    i5 = '<urn:schemas-rinconnetworks-com:metadata-1-0/:radioShowMd></urn:schemas-rinconnetworks-com:metadata-1-0/:radioShowMd>'
    i6 = '<http://purl.org/dc/elements/1.1/:title>Sound Of Silence</http://purl.org/dc/elements/1.1/:title>'
    i7 = '<urn:schemas-upnp-org:metadata-1-0/upnp/:class>object.item.audioItem.musicTrack.sonosMusicTrack</urn:schemas-upnp-org:metadata-1-0/upnp/:class>'
    i8 = '<http://purl.org/dc/elements/1.1/:creator>All Angels</http://purl.org/dc/elements/1.1/:creator>'
    i9 = '<urn:schemas-upnp-org:metadata-1-0/upnp/:album>Into Paradise</urn:schemas-upnp-org:metadata-1-0/upnp/:album>'
    i10 = '<urn:schemas-upnp-org:metadata-1-0/upnp/:originalTrackNumber>6</urn:schemas-upnp-org:metadata-1-0/upnp/:originalTrackNumber>'
    i11 = '<urn:schemas-rinconnetworks-com:metadata-1-0/:albumArtist>All Angels</urn:schemas-rinconnetworks-com:metadata-1-0/:albumArtist>'
    i12 = '</item></DIDL-Lite>'
    i = i1+i2+i3+i4+i5+i6+i7+i8+i9+i10+i11+i12
    '''
    
    i1 = '<DIDL-Lite xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:upnp="urn:schemas-upnp-org:metadata-1-0/upnp/" xmlns:r="urn:schemas-rinconnetworks-com:metadata-1-0/" xmlns="urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/">'
    i2 = '<item id="-1" parentID="-1" restricted="true">'
    i3 = '<res protocolInfo="x-file-cifs:*:audio/flac:*" duration="0:04:06">'
    i4 = 'x-file-cifs://NAS/Music/All%20Angels/Into%20Paradise/06%20Sound%20Of%20Silence.flac</res>'
    i5 = '<r:streamContent xmlns:r="urn:schemas-rinconnetworks-com:metadata-1-0/"></r:streamContent>'
    i6 = '<r:radioShowMd xmlns:r="urn:schemas-rinconnetworks-com:metadata-1-0/"></r:radioShowMd>'
    i7 = '<dc:title xmlns:dc="http://purl.org/dc/elements/1.1/">Sound Of Silence</dc:title>'
    i8 = '<upnp:class xmlns:upnp="urn:schemas-upnp-org:metadata-1-0/upnp/">object.item.audioItem.musicTrack.sonosMusicTrack</upnp:class>'
    i9 = '<dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">All Angels</dc:creator>'
    i10 = '<upnp:album xmlns:upnp="urn:schemas-upnp-org:metadata-1-0/upnp/">Into Paradise</upnp:album>'
    i11 = '<upnp:originalTrackNumber xmlns:upnp="urn:schemas-upnp-org:metadata-1-0/upnp/">6</upnp:originalTrackNumber>'
    i12 = '<r:albumArtist xmlns:r="urn:schemas-rinconnetworks-com:metadata-1-0/">All Angels</r:albumArtist>'
    i13 = '</item></DIDL-Lite>'
    i = i1+i2+i3+i4+i5+i6+i7+i8+i9+i10+i11+i12+i13


#    ip('didl.xml') 
#    ip('didl2.xml') 

#    test()
    process_event_tags_avt(i)

#    print minidom.parseString(i).toprettyxml()
#    ii = parse_xml(i)
#    print ii
#    ii = ii.getroot()
#    print ii
#    print minidom.parseString(ElementTree.tostring(ii)).toprettyxml()
#    print ElementTree.tostring(ii)


if __name__ == "__main__":
    main()    
